<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><link rel="icon" href="/favicon.ico" sizes="32x32" type="image/x-icon"><meta name="viewport" content="width=device-width, min-width=800"><link rel="stylesheet" href="/static/css/styles.css"><link rel="preconnect" href="https://fonts.gstatic.com"><link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;1,100;1,200;1,300;1,400;1,500;1,600;1,700&amp;family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&amp;display=swap" rel="stylesheet"><meta name="description" content="This page talks describes how constexpr.js figures how the dependencies of a page"><meta name="keywords" content="constexpr.js"><title>Dependency resolution in constexpr.js</title><link rel="stylesheet" href="/static/css/prism.css"></head><body><div id="left-sidebar">
    <div class="heading">Table of content</div>
    <ol id="table-of-content"><li><a href="#top">Top</a></li><li><a href="#summary">Summary</a></li></ol>
</div>
<img class="bg" id="main_bg" src="/static/img/bg.jpg" alt="">










<div id="body_wrapper" class="first_body_wrapper"><header><nav><a href="/">
              HOME
          </a><a href="/projects.html">
              PROJECTS
          </a><a href="/tags.html">
              TAGS
          </a></nav><h1 id="main_title">Dependency resolution in constexpr.js</h1><ul class="tags_list"><li><a class="tag_element" href="/tags/constexpr.js.html">constexpr.js</a></li></ul></header><article role="main">
    
    
    
    
    

    

    

    
    
    

    
    

    
<section id="top"><h2 style="display: none;">Top</h2><p>
        The dependency resolution system of constexpr.js is semi-automatic. The compiler figures out the dependencies
        (css, images, javascript, static files) of a page on its own, but the constexpr code inside a page can override
        the default behavior if it needs to. This article describes how the dependency resolution process works.
    </p><p>
        The compiler monitors the HTTP requests made by the pages when they're being rendered. All the local static
        resources requested by the page are added to the dependency list of that page, with the exception of script
        files which are marked as <progi role="figure">constexpr</progi>.
    </p><prog class=" language-html" role="figure"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/cat.jpg<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/js/ui.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">constexpr</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/js/packages/jquery.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">constexpr</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/js/render.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span></prog><p>
        The above snippet will cause <progi role="figure">ui.js</progi> and <progi role="figure">cat.jpg</progi> to be added to the dependency list of the page.
        <progi role="figure">jquery.js</progi> and <progi role="figure">render.js</progi> will not be added to the dependency list.
    </p><p>
        Consider what would've happened if the rendering code in the page fetched <progi role="figure">jquery.js</progi> using XHR
        and then <progi role="figure">eval</progi>d it. The compiler will think that the <progi role="figure">jquery.js</progi> file being fetched
        is a regular resource and will add it to the dependency list as well. You can use the
        <progi role="figure">window._ConstexprJS_.addExclusion</progi> hook to deal with this issue. Exclusions added using this
        method take precedence over the automatic dependency resolution:
    </p><prog class=" language-js" role="figure"><span class="token function">eval</span><span class="token punctuation">(</span><span class="token keyword control-flow">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/jquery.js'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token arrow operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token method function property-access">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token property-access">_ConstexprJS_</span><span class="token punctuation">.</span><span class="token method function property-access">addExclusion</span><span class="token punctuation">(</span><span class="token string">'/jquery.js'</span><span class="token punctuation">)</span></prog><p>
        Let's consider another scenario. What if some runtime code depended on <progi role="figure">jquery.js</progi> as well. The
        file won't be copied because it's excluded using the <progi role="figure">addExclusion</progi> hook. To deal with this issue,
        the compiler injects another hook called <progi role="figure">window._ConstexprJS_.addDependency</progi> that takes precedence
        over <progi role="figure">addExclusion</progi>. If a resource is specified as a dependency by the page using this hook, it
        will be included no matter what.
    </p></section><section id="summary"><h2>Summary</h2><p>
        These are the dependency resolution mechanisms used by constexpr.js compiler. Mechanisms lower in the list take
        precedence over the ones that appear before them:
    </p><ol>
        <li>HTTP requests made by the page. (included)</li>
        <li>Scripts included with <progi role="figure">constexpr</progi> attribute. (excluded)</li>
        <li><progi role="figure">addExclusion</progi> hook. (excluded)</li>
        <li><progi role="figure">addDependency</progi> hook. (included)</li>
    </ol><h3>Note</h3><p>
        Dependencies aren't copied over if <progi role="figure">--skip-resources</progi> option is specified. The dependency
        resolution process works independent of this option and the dependency information will be exported if
        <progi role="figure">--deps</progi> option is specified.
    </p><blockquote>
        See pages tagged with <a class="tag_element" href="/tags/constexpr.js.html">constexpr.js</a> for more guides.
    </blockquote></section></article><footer>
    <div class="links">
        <div class="social">
            <div class="footer-title">Share this page:</div>
            <a rel="noopener" title="twitter" class="svg-icon twitter" target="_blank" href="https://twitter.com/share?text=Dependency resolution in constexpr.js&amp;url=https://fctorial.github.io/posts/constexprjs_dependency_resolution.html"></a>
            <a rel="noopener" title="facebook" class="svg-icon facebook" target="_blank" href="https://www.facebook.com/sharer.php?u=https://fctorial.github.io/posts/constexprjs_dependency_resolution.html"></a>
            <a rel="noopener" title="reddit" class="svg-icon reddit" target="_blank" href="https://www.reddit.com/submit?title=Dependency resolution in constexpr.js&amp;url=https://fctorial.github.io/posts/constexprjs_dependency_resolution.html"></a>
            <a rel="noopener" title="hacker news" class="svg-icon hn" target="_blank" href="https://news.ycombinator.com/submitlink?t=Dependency resolution in constexpr.js&amp;u=https://fctorial.github.io/posts/constexprjs_dependency_resolution.html"></a>
        </div>
        <div class="social">
            <div class="footer-title">Contacts:</div>
            <a rel="noopener" title="github" href="https://github.com/fctorial" class="svg-icon github"></a>
            <a rel="noopener" title="twitter" href="https://twitter.com/fctorial1" class="svg-icon twitter"></a>
            <a rel="noopener" title="email" href="mailto:fctorial@gmail.com" class="svg-icon email"></a>
        </div>
    </div>

<a rel="noopener" class="discussion" target="_blank" href="https://www.reddit.com/r/fctorial/comments/mp0tge/dependency_resolution_in_constexprjs/">Join the discussion here</a></footer></div><div id="right-sidebar"></div></body></html>